"use strict";function Particle(t,e){this.xpos=t,this.ypos=e}function Antropy(){this.inited=!1,this.antNumber,this.foodSource,this.foodNumber,this.stepNumber,this.run=null}function AntSpace(t,e){AntSpace.cellSize=Math.floor(Math.min(t,e)/AntSpace.spaceSize)}function Hive(){this.hiveDrawSize=10,this.pos2D=AntSpace.center(),this.collectedFood=0}function Foods(t){this.antropy=t,this.foodSource=Math.max(this.antropy.foodSource,1),this.foodNumber=this.antropy.foodNumber,this.foodDeviation=5,this.food=[],this.pos2D=[];for(var e=0;e<this.foodSource;++e){this.pos2D[e]=new Point(Math.floor(Math.random()*AntSpace.spaceSize),Math.floor(Math.random()*AntSpace.spaceSize));for(var o=0;o<this.foodNumber/this.foodSource;++o){var n=get2DGaussian(this.pos2D[e],this.foodDeviation);this.food[e*Math.floor(this.foodNumber/this.foodSource)+o]=new Food,this.food[e*Math.floor(this.foodNumber/this.foodSource)+o].pos2D=new Point(AntSpace.crop2Space(Math.floor(n.x)),AntSpace.crop2Space(Math.floor(n.y)))}}for(var o=0;o<this.foodNumber-this.foodSource*Math.floor(this.foodNumber/this.foodSource);++o){var n=get2DGaussian(this.pos2D[0],this.foodDeviation);this.food[this.foodSource*Math.floor(this.foodNumber/this.foodSource)+o]=new Food,this.food[this.foodSource*Math.floor(this.foodNumber/this.foodSource)+o].pos2D=new Point(AntSpace.crop2Space(Math.floor(n.x)),AntSpace.crop2Space(Math.floor(n.y)))}}function Food(){this.x=0,this.y=0,this.consumed=!1}function Ants(t){this.antropy=t,this.ant=[],this.carryingFood=0,this.antNumber=this.antropy.antNumber;for(var e=0;e<this.antNumber;++e)this.ant[e]=new Ant(this.antropy,e);this.selected_ant_id=0}function Ant(t,e){this.id=e,this.antropy=t,this.x=AntSpace.center().x,this.y=AntSpace.center().y,this.heading=Math.floor(Math.random()*Ants.NEIGHBOURS.length),this.pheromoneHive=0,this.pheromoneFood=0,this.carriedFood=null,this.mode=Ants.MODE_SEARCH}function PheromoneMatrix(){this.read_matrix=create2DArray(AntSpace.spaceSize),this.write_matrix=create2DArray(AntSpace.spaceSize)}function Pheromone(t){this.antropy=t,this.hive_matrix=new PheromoneMatrix,this.food_matrix=new PheromoneMatrix,this.evap_rate=.01,this.diffusion_constant=.86}function CanvasData(t){this.realcanvas=document.getElementById(t),this.ctx=this.realcanvas.getContext("2d"),this.offCanvas=document.createElement("canvas"),this.offCanvas.width=this.realcanvas.width,this.offCanvas.height=this.realcanvas.height,this.offctx=this.offCanvas.getContext("2d")}function Point(t,e){this.x=t,this.y=e}function gauss_random(){return 2*Math.random()-1+(2*Math.random()-1)+(2*Math.random()-1)}function get2DGaussian(t,e){return new Point(gauss_random()*e+t.x,gauss_random()*e+t.y)}function sign(t){return"number"==typeof t?t?t<0?-1:1:t===t?0:NaN:NaN}function create2DArray(t,e){var o=[];e=e||t;for(var n=0;n<t;n++)o[n]=new Array(e);return o}function copy2DArray(t,e){var o;for(o in t)e.push(t[o].slice())}function decimalToHexString(t){return t=t||0,t<0&&(t=4294967295+t+1),t.toString(16).toUpperCase()}function lpad(t,e,o){for(;t.length<o;)t=e+t;return t}function decimal_pad(t,e,o){if(o=o||"0",t=t.toString(),!e)return t;t.indexOf(".")===-1&&(t+=".");var n=t.indexOf(".");n=n!==-1?t.length-n-1:-1;for(var i=n;i<e;i++)t+=o;return t}function getDistance(t,e){var o=Math.abs(t-e),n=AntSpace.spaceSize;return o>n/2&&(o=n-o),o}function getDistance2(t,e){var o=getDistance(t.x,e.x),n=getDistance(t.y,e.y);return Math.sqrt(o*o+n*n)}function getEntropy(t){var e=t.length;if(e<2)return 1;for(var o=0,n=0;n<e;n++)for(var i=t[n],a=n+1;a<e;a++){var s=t[a];o+=getDistance2(i,s)}return o/(e*(e-1)/2)}function Graph(t,e,o,n,i,a,s,r,h,c){var p,d,l,f,u,y,m,v,A,S,g,x,_,E,w,M,b,H,N,D,O,P,F,I,T=t,R=e,C=15,z=20;p=s,d=r,l=h,f=c,_=(n-o)/h,E=(a-i)/c,u=o/_,y=n/_,m=i/E,v=a/E,w=u+p,M=y+p,b=d-m,H=d-v,F=p-C,I=d,this.drawgrid=function(t,e,o,n){A=t/_,S=e/_,g=o/E,x=n/E,T.strokeStyle="#999999",T.lineWidth=1,T.beginPath(),D=H;do T.moveTo(w,D),T.lineTo(M,D),D+=g;while(D<=b);N=w;do T.moveTo(N,b),T.lineTo(N,H),N+=A;while(N<=M);T.stroke(),T.strokeStyle="#cccccc",T.lineWidth=1,T.beginPath(),D=H;do T.moveTo(w,D),T.lineTo(M,D),D+=x;while(D<=b);N=w;do T.moveTo(N,b),T.lineTo(N,H),N+=S;while(N<=M);T.stroke(),T.font="10pt Lato",T.fillStyle="#000000",T.textAlign="right",T.textBaseline="top",D=H;do P=Math.round((d-D)*E),T.fillText(P,F+5,D-z/2),D+=g;while(D<=b);T.textAlign="left",T.textBaseline="top",N=w;do O=Math.round((N-p)*_),T.fillText(O,N-C+10,I+5),N+=A;while(N<=M)},this.drawaxes=function(t,e){"undefined"==typeof t&&(t="x"),"undefined"==typeof e&&(e="y"),T.strokeStyle="#000000",T.lineWidth=2,T.beginPath(),T.moveTo(w,d),T.lineTo(M,d),T.moveTo(p,b),T.lineTo(p,H),T.stroke(),T.font="12pt Lato",T.fillStyle="#000000",T.textAlign="left",T.textBaseline="top",T.fillText(t,M+.75*C,I-z/2),T.fillText(e,F+C/2+5,H-1.5*z)},this.plot1data=function(t,e){var o=p+t/_,n=d-e/E;R.beginPath(),R.arc(o,n,1,0,2*Math.PI,!0),R.stroke()},this.plot=function(t,e){"undefined"==typeof e&&(e="#0000ff"),R.strokeStyle=e,R.lineWidth=1;for(var o in t)this.plot1data(o,t[o])},this.plot1=function(t,e,o,n){"undefined"==typeof n&&(n="#0000ff"),R.lineWidth=1;var i=R.globalCompositeOperation;R.globalCompositeOperation="destination-out",R.strokeStyle="rgba(255,255,255,1.0)",this.plot1data(t,e),R.globalCompositeOperation=i,R.strokeStyle=n,this.plot1data(t,o)}}function GraphHandler(t){this.antropy=t,this.canvas=this.antropy.entropy_canvas.realcanvas,this.plot_canvas=this.antropy.plot_canvas.realcanvas,this.context=this.antropy.entropy_canvas.ctx,this.plot_context=this.antropy.plot_canvas.ctx,this.antEntropyHist=[],this.foodEntropyHist=[],this.xmax=100,this.ymax=50,this.needResize=!0}Particle.prototype={get pos2D(){return new Point(this.xpos,this.ypos)},set pos2D(t){this.xpos=t.x,this.ypos=t.y},get x(){return AntSpace.crop2Space(this.xpos)},set x(t){this.xpos=AntSpace.crop2Space(t)},get y(){return AntSpace.crop2Space(this.ypos)},set y(t){this.ypos=AntSpace.crop2Space(t)},get canvasPos2D(){return AntSpace.point2Canvas(this.pos2D)}},Particle.prototype.draw=function(t,e){t.beginPath(),t.arc(this.canvasPos2D.x,this.canvasPos2D.y,e,0,2*Math.PI),t.fill()},Antropy.prototype.setCanvases=function(t,e){this.canvasid=t,this.pheromone_canvasid=e},Antropy.prototype.setEntropyCanvases=function(t,e){this.entropy_canvasid=t,this.plot_canvasid=e},Antropy.prototype.setWindow=function(t){this.window=t},Antropy.prototype.setButton=function(t){this.button=t},Antropy.prototype.reset=function(){this.seed=document.getElementById("seed").value,this.antNumber=document.getElementById("antnum").value,this.foodSource=document.getElementById("foodsource").value,this.foodNumber=document.getElementById("foodnum").value,Math.seedrandom(this.seed),this.inited=!1,this.run=null,this.init()},Antropy.prototype.init=function(){this.canvas=new CanvasData(this.canvasid),this.canvas.realcanvas.addEventListener("mousedown",this.showCellData,!1),this.canvas.realcanvas.ownParam=this,this.pheromone_canvas=new CanvasData(this.pheromone_canvasid),this.entropy_canvas=new CanvasData(this.entropy_canvasid),this.plot_canvas=new CanvasData(this.plot_canvasid),this.antSpace=new AntSpace(this.canvas.width,this.canvas.height),this.hive=new Hive,this.foods=new Foods(this),this.pheromone=new Pheromone(this),this.ants=new Ants(this),this.antEntropy=0,this.foodEntropy=0,this.graphHandler=new GraphHandler(this),this.stepNumber=0,this.inited=!0,this.draw()},Antropy.prototype.step=function(){var t=+new Date;this.inited||this.reset(),this.pheromone.step(),this.ants.step(),this.hive.getFood()==this.foods.maxFood&&this.run&&this.toggle(),this.draw();var e=+new Date,o=e-t;if(document.getElementById("speed").value=o,document.getElementById("food").value=this.hive.getFood()+"/"+this.foods.maxFood+(this.hive.getFood()==this.foods.maxFood?" ALL COLLECTED":""),document.getElementById("stepnum").value=++this.stepNumber,document.getElementById("ant_food").value=this.ants.carryingFood,document.getElementById("ant_search").value=this.ants.antNumber-this.ants.carryingFood,this.antEntropy=Math.round(1e4*getEntropy(this.ants.ant))/1e4,document.getElementById("ant_entropy").value=this.antEntropy,this.foodEntropy=Math.round(1e4*getEntropy(this.foods.food))/1e4,document.getElementById("food_entropy").value=this.foodEntropy,null!==this.ants.selected_ant_id){document.getElementById("ant_id").value=this.ants.selected_ant_id;var n=this.ants.ant[this.ants.selected_ant_id];document.getElementById("ant_x").value=n.x,document.getElementById("ant_y").value=n.y,document.getElementById("ant_heading").value=n.heading,document.getElementById("ant_mode").value=n.mode===Ants.MODE_SEARCH?"SEARCH":"HOME"}},Antropy.prototype.toggle=function(){this.run?(this.run=this.window.clearInterval(this.run),this.button.innerHTML=this.button.innerHTML.replace("Stop","Run"),this.button.innerHTML=this.button.innerHTML.replace("glyphicon-stop","glyphicon-play")):(this.run=this.window.setInterval(function(){antropy.step()},10),this.button.innerHTML=this.button.innerHTML.replace("Run","Stop"),this.button.innerHTML=this.button.innerHTML.replace("glyphicon-play","glyphicon-stop"))},Antropy.prototype.draw=function(){this.canvas.clear(),this.pheromone_canvas.clear(),this.hive.draw(this.canvas.context),this.foods.draw(this.canvas.context),this.pheromone.draw(this.pheromone_canvas.context),this.ants.draw(this.canvas.context),this.canvas.paint(),this.pheromone_canvas.paint(),this.graphHandler.draw(this.antEntropy,this.foodEntropy)},Antropy.prototype.showCellData=function(t){for(var e=AntSpace.canvas2Point(new Point(t.clientX-canvas.offsetLeft,t.clientY-canvas.offsetTop)),o=t.target.ownParam,n="",i="",a=-1;a<=1;++a){for(var s=-1;s<=1;++s){var r=Math.round(100*o.pheromone.getFoodAt(e.x+s,e.y+a))/100;n+=lpad(decimal_pad(r,2,"0")," ",5)+", ";var h=Math.round(100*o.pheromone.getHiveAt(e.x+a,e.y+a))/100;i+=lpad(decimal_pad(h,2,"0")," ",5)+", "}n+="\n",i+="\n"}o.ants.selectAnt(e)},AntSpace.cellSize,AntSpace.spaceSize=100,AntSpace.point2Canvas=function(t){return new Point(t.x*AntSpace.cellSize,t.y*AntSpace.cellSize)},AntSpace.canvas2Point=function(t){return new Point(Math.floor(t.x/AntSpace.cellSize),Math.floor(t.y/AntSpace.cellSize))},AntSpace.center=function(){return new Point(AntSpace.spaceSize/2,AntSpace.spaceSize/2)},AntSpace.crop2Space=function(t){return(t+AntSpace.spaceSize)%AntSpace.spaceSize},Hive.prototype=Object.create(Particle.prototype),Hive.prototype.constructor=Hive,Hive.prototype.getFood=function(){return this.collectedFood},Hive.prototype.draw=function(t){t.fillStyle="blue",Particle.prototype.draw.call(this,t,this.hiveDrawSize)},Hive.prototype.isIn=function(t){return(t.x-this.x)*(t.x-this.x)+(t.y-this.y)*(t.y-this.y)<this.hiveDrawSize/AntSpace.cellSize*this.hiveDrawSize/AntSpace.cellSize},Hive.prototype.stock=function(t){++this.collectedFood},Foods.prototype=Object.create(Particle.prototype),Foods.prototype.constructor=Foods,Foods.prototype={get maxFood(){return this.foodNumber},set maxFood(t){this.foodNumber=t}},Foods.foodSize=2,Foods.prototype.getFoodAt=function(t){for(var e=0,o=0;o<this.foodNumber&&!e;++o)this.food[o].consumed||this.food[o].x!==t.x||this.food[o].y!==t.y||(e=o+1,this.food[o].consumed=!0);return e},Foods.prototype.setFoodPos=function(t,e){t>0&&t<=this.foodNumber&&(this.food[t-1].pos2D=e)},Foods.prototype.draw=function(t){t.fillStyle="green";for(var e=0;e<this.foodNumber;++e)this.food[e].draw(t,Foods.foodSize)},Food.prototype=Object.create(Particle.prototype),Food.prototype.constructor=Food,Ants.ANT_SIZE=3,Ants.NEIGHBOURS=[[0,-1],[-1,-1],[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1]],Ants.NO_HEADINGS=Ants.NEIGHBOURS.length,Ants.STEPS_AHEAD=3,Ants.STARTING_PHEROMONE=100,Ants.PHEROMONE_DECREASE=2,Ants.MODE_SEARCH=1,Ants.MODE_HOME=2,Ants.MOVE_RANDOM=.1,Ants.ATTRACTION_LEVEL=1,Ants.prototype.draw=function(t){t.fillStyle="red",t.strokeStyle="red";for(var e=0;e<this.antNumber;++e)this.selected_ant_id!==e&&null===this.ant[e].carriedFood&&this.ant[e].draw(t);t.strokeStyle="green";for(var e=0;e<this.antNumber;++e)this.selected_ant_id!==e&&null!==this.ant[e].carriedFood&&this.ant[e].draw(t);null!==this.selected_ant_id&&(t.fillStyle="yellow",this.ant[this.selected_ant_id].draw(t),null===this.ant[this.selected_ant_id].carriedFood&&(t.strokeStyle="red"))},Ants.prototype.step=function(){this.carryingFood=0;for(var t=0;t<this.antNumber;++t)this.ant[t].step()},Ants.prototype.getAntAt=function(t){for(var e=null,o=0;o<this.antNumber&&!e;++o)this.ant[o].x===t.x&&this.ant[o].y===t.y&&(e=o);return e},Ants.prototype.selectAnt=function(t){this.selected_ant_id=antropy.ants.getAntAt(t)},Ant.prototype=Object.create(Particle.prototype),Ant.prototype.constructor=Ant,Ant.prototype.draw=function(t){Particle.prototype.draw.call(this,t,Ants.ANT_SIZE);var e=this.canvasPos2D;t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(e.x+5*Ants.NEIGHBOURS[this.heading][0],e.y+5*Ants.NEIGHBOURS[this.heading][1]),t.stroke(),this.carriedFood&&(t.beginPath(),t.arc(e.x,e.y,Ants.ANT_SIZE,0,2*Math.PI),t.stroke())},Ant.prototype.step=function(){this.foodCheck()||(this.hiveCheck(),Math.random()>Ants.MOVE_RANDOM?this.maxMove():this.randomWalkMode(),this.carriedFood&&(this.antropy.foods.setFoodPos(this.carriedFood,this.pos2D),++this.antropy.ants.carryingFood))},Ant.prototype.randomWalkMode=function(){var t=gauss_random(),e=sign(t)*Math.min(Math.floor(Math.abs(t)),Math.floor(Ants.STEPS_AHEAD/2));this.heading=Math.floor(this.heading+e+Ants.NO_HEADINGS)%Ants.NO_HEADINGS,this.x+=Ants.NEIGHBOURS[this.heading][0],this.y+=Ants.NEIGHBOURS[this.heading][1]},Ant.prototype.maxMove=function(){var t,e=0,o=this.x,n=this.y,i=0;t=[];for(var a=-Math.floor(Ants.STEPS_AHEAD/2);a<=Math.floor(Ants.STEPS_AHEAD/2);++a){var s=this.x+Ants.NEIGHBOURS[Math.floor((this.heading+a+Ants.NO_HEADINGS)%Ants.NO_HEADINGS)][0];s=AntSpace.crop2Space(s);var r=this.y+Ants.NEIGHBOURS[Math.floor((this.heading+a+Ants.NO_HEADINGS)%Ants.NO_HEADINGS)][1];r=AntSpace.crop2Space(r),this.mode===Ants.MODE_SEARCH?i=this.antropy.pheromone.getFoodAt(s,r):this.mode===Ants.MODE_HOME&&(i=this.antropy.pheromone.getHiveAt(s,r)),i>e&&(e=i,o=s,n=r,t=[]),i>=e&&(t[t.length]=a,t[t.length]=s,t[t.length]=r,0===a&&(t[t.length]=a,t[t.length]=s,t[t.length]=r))}if(e>Ants.ATTRACTION_LEVEL){var h=Math.floor(Math.random()*t.length/3);this.x=t[3*h+1],this.y=t[3*h+2],this.heading=Math.floor((this.heading+t[3*h]+Ants.NO_HEADINGS)%Ants.NO_HEADINGS)}else this.randomWalkMode()},Ant.prototype.foodCheck=function(){if(this.carriedFood)return!1;var t=this.antropy.foods.getFoodAt(this.pos2D);return!!t&&(this.carriedFood=t,this.mode=Ants.MODE_HOME,this.pheromoneFood=Ants.STARTING_PHEROMONE,!0)},Ant.prototype.hiveCheck=function(){return!(!this.antropy.hive.isIn(this.pos2D)||(this.pheromoneHive=Ants.STARTING_PHEROMONE,!this.carriedFood))&&(this.antropy.hive.stock(),this.carriedFood=null,this.mode=Ants.MODE_SEARCH,!0)},Ant.prototype.getEmittedPheromoneHive=function(){var t=this.pheromoneHive;return this.pheromoneHive=Math.max(0,this.pheromoneHive-Ants.PHEROMONE_DECREASE),t},Ant.prototype.getEmittedPheromoneFood=function(){if(this.carriedFood){var t=this.pheromoneFood;return this.pheromoneFood=Math.max(0,this.pheromoneFood-Ants.PHEROMONE_DECREASE),t}return 0},PheromoneMatrix.prototype.update=function(){this.read_matrix=[],copy2DArray(this.write_matrix,this.read_matrix)},Pheromone.prototype.step=function(){this.diffuse(this.hive_matrix),this.diffuse(this.food_matrix),this.calculate(this.hive_matrix,!0),this.calculate(this.food_matrix,!1),this.update()},Pheromone.prototype.draw=function(t){for(var e=0;e<this.hive_matrix.read_matrix.length;++e)for(var o=0;o<this.hive_matrix.read_matrix[e].length;++o){var n=Math.min(Math.round(this.hive_matrix.read_matrix[e][o]||0),255),i=Math.min(Math.round(this.food_matrix.read_matrix[e][o]||0),255);t.fillStyle="rgb(0,"+i+","+n+")";var a=AntSpace.point2Canvas(new Point(e,o));t.fillRect(a.x-AntSpace.cellSize/2,a.y-AntSpace.cellSize/2,AntSpace.cellSize,AntSpace.cellSize)}},Pheromone.prototype.calculate=function(t,e){for(var o=0;o<this.antropy.ants.antNumber;++o)t.write_matrix[this.antropy.ants.ant[o].x][this.antropy.ants.ant[o].y]=(t.write_matrix[this.antropy.ants.ant[o].x][this.antropy.ants.ant[o].y]||0)+(e?this.antropy.ants.ant[o].getEmittedPheromoneHive():this.antropy.ants.ant[o].getEmittedPheromoneFood())},Pheromone.prototype.diffuse=function(t){for(var e=0;e<t.write_matrix.length;++e)for(var o=0;o<t.write_matrix[e].length;++o){for(var n=0,i=0;i<8;++i)n+=t.read_matrix[AntSpace.crop2Space(e+Ants.NEIGHBOURS[i][0])][AntSpace.crop2Space(o+Ants.NEIGHBOURS[i][1])]||0;var a=n/8*(1-this.diffusion_constant),s=this.diffusion_constant*(t.read_matrix[e][o]||0);s+=a,s*=1-this.evap_rate,t.write_matrix[e][o]=s}},Pheromone.prototype.update=function(){this.hive_matrix.update(),this.food_matrix.update()},Pheromone.prototype.getFoodAt=function(t,e){return this.food_matrix.read_matrix[AntSpace.crop2Space(t)][AntSpace.crop2Space(e)]},Pheromone.prototype.getHiveAt=function(t,e){return this.hive_matrix.read_matrix[AntSpace.crop2Space(t)][AntSpace.crop2Space(e)]},CanvasData.prototype={get context(){return this.offctx},get width(){return this.realcanvas.width},get height(){return this.realcanvas.height}},CanvasData.prototype.clear=function(){this.ctx.clearRect(0,0,this.realcanvas.width,this.realcanvas.height),this.offctx.clearRect(0,0,this.realcanvas.width,this.realcanvas.height)},CanvasData.prototype.paint=function(){this.ctx.drawImage(this.offCanvas,0,0)},GraphHandler.prototype.draw=function(t,e){if(this.antEntropyHist.push(t),this.foodEntropyHist.push(e),this.antEntropyHist.length>=this.xmax&&(this.xmax=2*this.xmax,this.needResize=!0),(t>=this.ymax||e>=this.ymax)&&(this.ymax=2*this.ymax,this.needResize=!0),this.needResize){this.needResize=!1,this.context.clearRect(0,0,this.canvas.width,this.canvas.height);var o=30;this.graph=new Graph(this.context,this.plot_context,0,this.xmax,0,this.ymax,o,this.plot_context.canvas.height-o,this.plot_context.canvas.width-70,this.plot_context.canvas.height-60),this.graph.drawgrid(this.xmax/5,this.xmax/20,this.ymax/5,this.ymax/20),this.graph.drawaxes("step","entropy")}this.plot_context.clearRect(0,0,this.plot_canvas.width,this.plot_canvas.height),this.graph.plot(this.antEntropyHist,"#0000ff"),this.graph.plot(this.foodEntropyHist,"#00ff00")};